"use strict";function panel_horizontalbar(a){var b=this;this.constructorName="panel_horizontalbar",this.defaultInit={group:0,position:void 0,dim:0,valpos:[0],valneg:[],ratio:!1,centered:!1,domain:[],domainr:[]},this.actualInit=global.combineObjects(b.defaultInit,a),this.dimToShow=b.actualInit.dim,this.valPosToShow=b.actualInit.valpos,this.valNegToShow=b.actualInit.valneg,this.valMultipliers=[],this.valFraction=b.actualInit.ratio,this.isAlwaysCentered=b.actualInit.centered,this.preparedData,this.maxEntries=global.maxEntriesIn1D,this.shadowTimeout,this.buildValueVectors(),Panel.call(b,b.actualInit,global.mediators[b.actualInit.group],!b.singleValMode,global.legendOffsetX,global.legendOffsetX,0,global.fontSizeSmall+2),this.xAxisColor=global.readableColor(global.colorValue(b.valBarsToShow[0])),this.xScale=d3.scaleLinear().range([0,b.width]).nice(7),this.yScale=d3.scaleLinear().range([0,b.height]),this.xAxis=d3.svg.axis().scale(b.xScale).orient("bottom").ticks(7).tickFormat(global.cleverRound3),b.svg.insert("svg:g",".title_group").attr("class","minus background listener droptarget droptarget1").on("mouseover",function(){b.hoverOn(this,"minus")}).on("mouseout",function(){b.hoverOff()}).append("svg:rect").attr("width",b.w/2).attr("height",b.h),b.svg.insert("svg:g",".title_group").attr("class","plus background listener droptarget droptarget1").on("mouseover",function(){b.hoverOn(this,"plus")}).on("mouseout",function(){b.hoverOff()}).append("svg:rect").attr("x",b.w/2).attr("width",b.w/2).attr("height",b.h),b.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("click",function(){b.drill()}).on("mouseover",function(){b.hoverOn(this)}).on("mouseout",function(){b.hoverOff()}).append("svg:rect").attr("width",b.w).attr("height",b.h),this.gAxisYShadow=b.svg.insert("svg:g",".title_group").attr("class","axisX axis").attr("transform","translate("+b.margin.left+", "+b.margin.top+")"),this.gBars=b.svg.insert("svg:g",".title_group").attr("class","bar_group").attr("transform","translate("+b.margin.left+", "+b.margin.top+")"),this.gAxisX=b.svg.insert("svg:g",".title_group").attr("class","axisY axis noEvents").attr("transform","translate("+b.margin.left+", "+(b.margin.top+b.height)+")"),this.gAxisY=b.svg.insert("svg:g",".title_group").attr("class","axisX axis noEvents").attr("transform","translate("+b.margin.left+", "+b.margin.top+")"),b.gAxisY.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",b.height);var c;c=b.mediator.subscribe("changeValue",function(a,c,d,e){b.doChangeValue(a,c,d,e)}),b.mediatorIds.push({channel:"changeValue",id:c.id}),c=b.mediator.subscribe("changeDimension",function(a,c,d){b.doChangeDimension(a,c)}),b.mediatorIds.push({channel:"changeDimension",id:c.id}),b.mediator.publish("register",b,b.panelId,[b.dimToShow],b.preUpdate,b.update,b.getConfig)}var horizontalbarpanel=panel_horizontalbar;panel_horizontalbar.prototype=global.subclassOf(Panel),panel_horizontalbar.prototype.barPadding=.1,panel_horizontalbar.prototype.barValuesToShow=function(a){for(var b=this.valuesToShow(a,!0),c=this.valuesToShow(a,!1),d=0;d<c.length;d++)c[d].accumulation=-c[d].accumulation-c[d].value;return c.concat(b)},panel_horizontalbar.prototype.valuesToShow=function(a,b){var c=b?this.valPosToShow:this.valNegToShow,d=[];if(void 0!==a&&void 0!==a.vals)for(var e=0,f=0;f<c.length;f++){var g=b?this.valMultipliers[this.valNegNumber+f]:this.valMultipliers[f],h=this.valFraction?g*a.vals[c[f]].sz/a.vals[c[f]].n:a.vals[c[f]].sz;isNaN(parseInt(h))&&(h=0),d[f]={value:h,accumulation:e},e+=h}return d},panel_horizontalbar.prototype.getTooltip=function(a){for(var b=this,c=[],d=0;d<b.legendArray.length;d++){var e=b.legendArray[d],f=e.id,g=void 0;g=e.isNegRequired?a.values[global.positionInArray(b.valBarsToShow,f)].value:a.values[global.positionInArray(b.valBarsToShow,f)].value,c.push({name:b.meta.indicators[f].description,value:g,dimension:b.valFraction?b.meta.indicators[f].fraction.unit:b.meta.indicators[f].value.unit})}return b.createTooltip([{name:b.meta.dimensions[b.dimToShow].description,value:a.name?a.name:"Nincs adat"}],c)},panel_horizontalbar.prototype.setXScale=function(a){var b=this.valFraction?this.actualInit.domainr:this.actualInit.domain;b instanceof Array&&2===b.length?this.xScale.domain(b):this.xScale.domain(a),this.xScale.nice(10)},panel_horizontalbar.prototype.preUpdate=function(a){var b=this,c=b.preparedData;if(a.direction===-1)b.gAxisY.selectAll("text").filter(function(b){return b.id!==a.toId}).remove(),b.gAxisYShadow.selectAll("rect").on("click",null).remove(),b.gBars.selectAll(".bar").filter(function(b){return b.id!==a.toId}).on("click",null).remove();else if(1===a.direction){b.gAxisY.selectAll("text").filter(function(b){return b.id!==a.fromId}).remove(),b.gAxisYShadow.selectAll("rect").on("click",null).remove();for(var d=[],e=0,f=b.valBarNumber;e<f;e++){var g=d3.mean(c.dataArray,function(a){return a.values[e].width}),h=d3.mean(c.dataArray,function(a){return a.values[e].x});d.push({width:g,x:h})}b.gBars.selectAll(".bar").on("click",null).remove();var i=global.baseLevels[b.panelSide][this.dimToShow].length;b.gBars.selectAll(".bar").data([{id:a.fromId,uniqueId:i+"L"+a.fromId}]).enter().append("svg:g").attr("class","bar bordered darkenable").attr("transform","translate(0,"+b.yScale.range()[1]*(b.barPadding/2)+")").attr("opacity",1).selectAll("rect").data(d).enter().append("svg:rect").attr("class",function(a,c){return"controlled controlled"+b.valBarsToShow[c]}).attr("y",0).attr("height",b.yScale.range()[1]*(1-b.barPadding)).attr("x",function(a){return a.x}).attr("width",function(a){return a.width}).attr("fill",function(a,c){return global.colorValue(b.valBarsToShow[c])})}},panel_horizontalbar.prototype.prepareData=function(a,b,c){var d=this,e=global.baseLevels[d.panelSide][this.dimToShow].length,f=[];b.sort(d.cmp),d.yScale.domain([0,b.length]);var h,g=c.direction===-1&&a?global.getFromArrayByProperty(a.dataArray,"id",c.toId):null;if(1===c.direction)for(var i=0,j=b.length;i<j;i++)if(b[i].dims[0].id===c.fromId){h=i;break}for(var k=0,l=0,i=0,j=b.length;i<j;i++){var m=b[i],n={};n.index=i,n.id=m.dims[0].id,n.uniqueId=e+"L"+n.id,n.name=m.dims[0].name.trim(),n.values=d.barValuesToShow(m);var o=d.valPosNumber>0?n.values[n.values.length-1].value+n.values[n.values.length-1].accumulation:0,p=d.valNegNumber>0?n.values[d.valNegNumber-1].accumulation:0;k=Math.max(k,o),l=Math.min(l,p),n.tooltip=d.getTooltip(n),f.push(n)}d.isAlwaysCentered&&(k=Math.max(-l,k),l=-k);var q=d.yScale.range()[1],r=q*(1-d.barPadding),s=d.xScale.domain()[1]-d.xScale.domain()[0];d.setXScale([l,k]);for(var t=(d.xScale.domain()[1]-d.xScale.domain()[0])/s,u=d.yScale(1-d.barPadding),v=g?g.y:0,i=0,j=f.length;i<j;i++){n=f[i],n.y=d.yScale(i+d.barPadding/2),n.height=u;for(var w=0,x=d.valBarNumber;w<x;w++){var y=n.values[w];y.width=d.xScale(y.value)-d.xScale(0),y.x=d.xScale(y.accumulation),y.tooltip=n.tooltip}if(c.direction===-1&&g){n.oldY=v,n.oldHeight=g.height/j,v+=n.oldHeight;for(var w=0,x=d.valBarNumber;w<x;w++)n.values[w].oldWidth=g.values[w].width,n.values[w].oldX=g.values[w].x}else if(1===c.direction){n.oldY=(i-h+d.barPadding/2)*q,n.oldHeight=r;for(var w=0,x=d.valBarNumber;w<x;w++)n.values[w].oldWidth=global.orZero(t*n.values[w].width),n.values[w].oldX=global.orZero(t*(n.values[w].x-d.xScale(0))+d.xScale(0))}else{n.oldY=n.y,n.oldHeight=n.height;for(var w=0,x=d.valBarNumber;w<x;w++)n.values[w].oldWidth=0,n.values[w].oldX=d.xScale(0)}}return{dataArray:f}},panel_horizontalbar.prototype.update=function(a,b){var c=this;c.data=a||c.data,b=b||{dim:-1,direction:0};for(var d=!1,e=!1,f=0,g=c.legendArray.length;f<g;f++)c.meta.indicators[c.legendArray[f].id].value.hide&&(e=!0,c.valFraction=!0),c.meta.indicators[c.legendArray[f].id].fraction.hide&&(d=!0,c.valFraction=!1);if(c.data.rows.length>c.maxEntries)c.panic(!0,"<html>A panel nem képes "+c.data.rows.length+" értéket megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+c.maxEntries+".</html>"),c.preparedData=void 0;else if(d&&e)c.panic(!0,"<html>Az ellentétes megjelenítési utasítások miatt<br />az adatok nem megjeleníthetőek.</html>"),c.preparedData=void 0;else{c.panic(!1),c.valMultipliers=[];for(var f=0,g=c.valBarNumber;f<g;f++){var h=parseFloat(c.meta.indicators[c.valBarsToShow[f]].fraction.multiplier);c.valMultipliers.push(isNaN(h)?1:h)}var i=global.getAnimDuration(-1,c.panelId);c.preparedData=c.prepareData(c.preparedData,c.data.rows,b),c.drawAxes(c.preparedData,i),c.drawBars(c.preparedData,i)}if(c.singleValMode){var j=c.meta.indicators[c.legendArray[0].id];c.titleBox.update(c.legendArray[0].id,j.caption,j.value.unit,j.fraction.unit,c.valFraction,i)}else if(void 0===b.toId||b.dim===-1){for(var k=c.meta.indicators,l=[],m=[],n=[],o=[],f=0,g=c.legendArray.length;f<g;f++){var p=c.legendArray[f].id;l.push(p),m.push(k[p].caption),n.push(k[p].value.unit),o.push(k[p].fraction.unit)}c.titleBox.update(l,m,n,o,c.valFraction,i),c.drawLegend()}},panel_horizontalbar.prototype.drawBars=function(a,b){var c=this,d=c.gBars.selectAll(".bar").data(a.dataArray,function(a){return a.uniqueId});d.selectAll("rect").data(function(a){return a.values});var e=d.enter().append("svg:g").attr("class","bar bordered").attr("transform",function(a){return"translate(0,"+a.oldY+")"}).attr("opacity",function(a){return global.valueInRange(a.oldY+a.oldHeight/2,0,c.h)?1:0}),f=a.dataArray[0].oldHeight;e.selectAll("rect").data(function(a){return a.values}).enter().append("svg:rect").attr("y",0).attr("height",f).attr("x",function(a){return a.oldX}).attr("width",function(a){return a.oldWidth}).attr("fill",function(a,b){return global.colorValue(c.valBarsToShow[b])}),d.classed("listener",!0).on("click",function(a){c.drill(a)}),d.transition().duration(b).attr("transform",function(a){return"translate(0,"+a.y+")"}).attr("opacity",1).each("end",function(){d3.select(this).classed("darkenable",!0)}).selectAll("rect").attr("class",function(a,b){return"controlled controlled"+c.valBarsToShow[b]}).attr("x",function(a){return a.x}).attr("width",function(a){return a.width}).attr("height",c.yScale(1-c.barPadding)).attr("fill",function(a,b){return global.colorValue(c.valBarsToShow[b])}),d.exit().on("click",null).remove()},panel_horizontalbar.prototype.drawLegend=function(){var a=this;if(a.gLegend.selectAll(".legend").empty()){var b=a.legendWidth/a.legendArray.length,c=global.legendHeight,d=a.gLegend.selectAll("g.barLegend").data(a.legendArray).enter(),e=d.insert("svg:g",".bar_group").attr({class:function(a){return"listener droptarget droptarget1 legend legendControl"+a.id}}).on("mouseover",function(b){null===global.dragDropManager.draggedType?d3.select(this).classed("triggered",!0):a.hoverOn(this,b.id)}).on("mouseout",function(){null===global.dragDropManager.draggedType?d3.select(this).classed("triggered",!1):a.hoverOff()});e.append("svg:rect").attr("class","bordered").attr("rx",global.rectRounding).attr("ry",global.rectRounding).attr("x",function(a,c){return c*b+1.5*global.legendOffsetX}).attr("y",a.h-c-global.legendOffsetY).attr("width",b-global.legendOffsetX).attr("height",c).attr("fill",function(a){return global.colorValue(a.id)});var f=e.append("svg:text").attr("class","legend noEvents").attr("text-anchor","middle").attr("x",function(a,c){return c*b+b/2+global.legendOffsetX}).attr("y",a.h-c/2-global.legendOffsetY).attr("dy",".35em").attr("fill",function(a){return global.readableColor(global.colorValue(a.id))}).text(function(b,c){return a.meta.indicators[a.legendArray[c].id].caption});global.cleverCompress(f,b-1.8*global.legendOffsetX,1,void 0)}},panel_horizontalbar.prototype.drawAxes=function(a,b){var c=this,d=global.axisTextSize(c.yScale(1)),e=d<6?0:d;c.gAxisX.selectAll("path")[0].length>0?c.gAxisX.transition().duration(b).call(c.xAxis):c.gAxisX.call(c.xAxis);var f=c.xScale(0)<c.width/1.8,g=f?"beginning":"end",h=f?.2*e:-.2*e;c.gAxisY.selectAll("line").transition().duration(b).attr("y2",c.height),c.gAxisY.transition().duration(b).attr("transform","translate("+(c.margin.left+c.xScale(0))+","+c.margin.top+")"),c.svg.select(".minus rect").attr("x",0).attr("y",c.margin.top).attr("width",c.xScale(0)+c.margin.left).attr("height",c.height),c.svg.select(".plus rect").attr("x",c.margin.left+c.xScale(0)).attr("y",c.margin.top).attr("width",c.w-c.xScale(0)-c.margin.left).attr("height",c.height);var i=c.gAxisY.selectAll("text").data(a.dataArray,function(a){return a.id+a.name}),j=i.enter().append("svg:text").attr("class","shadowedLabel").attr("font-size",e).attr("opacity",function(a){return global.valueInRange(a.oldY+a.oldHeight/2,0,c.h)?0:global.axisTextOpacity}).attr("y",function(a){return a.oldY+a.oldHeight/2+.35*e});i.exit().transition().duration(b).attr("opacity",0).remove(),i.attr("dx",h).attr("text-anchor",g).text(function(a){return a.name}),i.transition().duration(b).attr("font-size",e).attr("y",function(a){return a.y+a.height/2+.35*e}).attr("opacity",global.axisTextOpacity),global.cleverCompress(j,c.w,.85*Math.max(c.width-c.xScale(0),c.xScale(0))/c.width,void 0),clearTimeout(c.shadowTimeout),c.gAxisYShadow.selectAll("rect").on("click",null).remove(),c.shadowTimeout=setTimeout(function(){c.gAxisYShadow.selectAll("rect").data(a.dataArray,function(a){return a.id+a.name}).enter().append("svg:rect").classed("listener",!0).attr("height",1.05*d).attr("width",function(a){return Math.max(30,Math.min(.5*d+c.gAxisY.selectAll("text").filter(function(b){return a===b})[0][0].getComputedTextLength(),Math.max(c.width-c.xScale(0),c.xScale(0))))}).attr("y",function(a){return a.y+(a.height-d)/2}).attr("x",function(){return f?c.xScale(0):c.xScale(0)-parseInt(d3.select(this).attr("width"))}).attr("opacity",0).on("click",function(a){c.drill(a)})},b)},panel_horizontalbar.prototype.buildValueVectors=function(){var a=this;a.valPosToShow=a.valPosToShow.filter(function(b,c){return a.valPosToShow.indexOf(b)===c}),a.valNegToShow=a.valNegToShow.filter(function(b,c){return a.valNegToShow.indexOf(b)===c}),a.valNegToShow=a.valNegToShow.filter(function(b){return a.valPosToShow.indexOf(b)===-1}),a.valBarsToShow=a.valNegToShow.concat(a.valPosToShow),a.valPosNumber=a.valPosToShow.length,a.valNegNumber=a.valNegToShow.length,a.valBarNumber=a.valPosNumber+a.valNegNumber,a.legendArray=a.createLegendArray(),a.singleValMode=1===a.legendArray.length},panel_horizontalbar.prototype.createLegendArray=function(){for(var a=this,b=d3.max([d3.max(a.valPosToShow),d3.max(a.valNegToShow)]),c=[],d=0,e=b+1;d<e;d++)c.push({id:d});for(var d=0,e=a.valPosNumber;d<e;d++)c[a.valPosToShow[d]].isPosRequired=!0;for(var d=0,e=a.valNegNumber;d<e;d++)c[a.valNegToShow[d]].isNegRequired=!0;for(var f=[],d=0,e=b+1;d<e;d++)(c[d].isPosRequired||c[d].isNegRequired)&&f.push(c[d]);return f},panel_horizontalbar.prototype.drill=function(a){global.tooltip.kill();var b={dim:this.dimToShow,direction:void 0===a?1:-1,toId:void 0===a?void 0:a.id,toName:void 0===a?void 0:a.name};this.mediator.publish("drill",b)},panel_horizontalbar.prototype.doChangeValue=function(a,b,c,d){var e=this;if(void 0===a||a===e.panelId){var f=e.legendArray.length;if(void 0!==c)e.valFraction=c===-1?!e.valFraction:c,void 0!==b&&e.singleValMode&&(1===e.valPosNumber&&(e.valPosToShow[0]=b),1===e.valNegNumber&&(e.valNegToShow[0]=b),e.buildValueVectors());else{if(b===-1&&e.singleValMode){var g=(e.legendArray[0].id+1)%e.meta.indicators.length;1===e.valPosNumber&&(e.valPosToShow[0]=g),1===e.valNegNumber&&(e.valNegToShow[0]=g)}if(b>-1&&("plus"===d||"minus"===d))if("plus"===d)e.valPosToShow.push(b);else{e.valNegToShow.push(b);var h=e.valPosToShow.indexOf(b);h!==-1&&e.valPosToShow.splice(h,1)}if(void 0===d&&(e.valPosToShow[0]=b,e.valPosToShow.length=1,e.valNegToShow.length=0),!isNaN(b)&&!isNaN(d)){var i=global.positionInArray(e.valPosToShow,d);i!==-1&&(e.valPosToShow[i]=b);var i=global.positionInArray(e.valNegToShow,d);i!==-1&&(e.valNegToShow[i]=b),e.gLegend.selectAll(".legend").remove()}e.buildValueVectors(),e.changeConfiguration(!e.singleValMode,global.legendOffsetX,global.legendOffsetX,0,global.fontSizeSmall+2),f!==e.legendArray.length&&(e.gBars.selectAll(".bar").remove(),e.gLegend.selectAll(".legend").remove()),e.svg.selectAll(".hoveredDropTarget").remove()}e.actualInit.valpos=e.valPosToShow,e.actualInit.valneg=e.valNegToShow,e.actualInit.ratio=e.valFraction,e.update()}},panel_horizontalbar.prototype.doChangeDimension=function(a,b){var c=this;a===c.panelId&&(c.dimToShow=b,c.actualInit.dim=c.dimToShow,c.mediator.publish("register",c,c.panelId,[c.dimToShow],c.preUpdate,c.update),global.tooltip.kill(),this.mediator.publish("drill",{dim:-1,direction:0,toId:void 0}))},panel_horizontalbar.prototype.changeConfiguration=function(a,b,c,d,e){this.isLegendRequired!==a&&(this.isLegendRequired=a,this.margin={top:global.panelTitleHeight+3*global.legendOffsetY+d,right:global.legendOffsetX+c,bottom:e+(a?global.legendHeight+2*global.legendOffsetY:global.legendOffsetY+global.legendHeight/2),left:global.legendOffsetX+b},this.width=this.w-this.margin.left-this.margin.right,this.height=this.h-this.margin.top-this.margin.bottom,this.yScale.range([0,this.height]),this.gAxisX.attr("transform","translate("+this.margin.left+", "+(this.margin.top+this.height)+")"))};