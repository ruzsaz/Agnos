"use strict";function panel_pie(a){var b=this;this.constructorName="panel_pie",this.defaultInit={group:0,position:void 0,dim:0,val:0,ratio:!1},this.actualInit=global.combineObjects(b.defaultInit,a),Panel.call(b,b.actualInit,global.mediators[b.actualInit.group],!1,0,0),this.valMultiplier=1,this.dimToShow=b.actualInit.dim,this.valToShow=b.actualInit.val,this.valFraction=b.actualInit.ratio,this.preparedData=[],this.maxEntries=global.maxEntriesIn1D,b.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("mouseover",function(){b.hoverOn(this)}).on("mouseout",function(){b.hoverOff()}).on("click",function(){b.drill()}).append("svg:rect").attr("width",b.w).attr("height",b.h),this.arc_group=b.svg.insert("svg:g",".title_group").attr("class","arc").attr("transform","translate("+(b.margin.left+b.width/2)+","+(b.margin.top+b.height/2)+")"),this.label_group=b.svg.insert("svg:g",".title_group").attr("class","label_group noEvents").attr("transform","translate("+(b.margin.left+b.width/2)+","+(b.margin.top+b.height/2)+")");var c;c=b.mediator.subscribe("changeValue",function(a,c,d){b.doChangeValue(a,c,d)}),b.mediatorIds.push({channel:"changeValue",id:c.id}),c=b.mediator.subscribe("changeDimension",function(a,c,d){b.doChangeDimension(a,c)}),b.mediatorIds.push({channel:"changeDimension",id:c.id}),b.mediator.publish("register",b,b.panelId,[b.dimToShow],b.preUpdate,b.update,b.getConfig)}var piechartpanel=panel_pie;panel_pie.prototype=global.subclassOf(Panel),panel_pie.prototype.requiredDifferenceForX=20,panel_pie.prototype.radius=.465*(global.panelHeight-global.panelTitleHeight-4*global.legendOffsetY-global.legendHeight/2),panel_pie.prototype.innerRadius=panel_pie.prototype.radius/3,panel_pie.prototype.textRadius=panel_pie.prototype.radius+14,panel_pie.prototype.labelMinValue=.3,panel_pie.prototype.arc=d3.svg.arc().startAngle(function(a){return a.startAngle}).endAngle(function(a){return a.endAngle}).outerRadius(panel_pie.prototype.radius).innerRadius(panel_pie.prototype.innerRadius),panel_pie.prototype.valueToShow=function(a){var b=this;if(void 0!==a&&void 0!==a.vals){var c=b.valFraction?b.valMultiplier*a.vals[b.valToShow].sz/a.vals[b.valToShow].n:a.vals[b.valToShow].sz;return isNaN(parseFloat(c))&&(c=0),c}return null},panel_pie.prototype.getTooltip=function(a){var b=this;return b.createTooltip([{name:b.meta.dimensions[b.dimToShow].description,value:a.name?a.name:"Nincs adat"}],[{name:b.meta.indicators[b.valToShow].description,value:a.value,dimension:b.valFraction?b.meta.indicators[b.valToShow].fraction.unit:b.meta.indicators[b.valToShow].value.unit}])},panel_pie.prototype.pieTween=function(a){var b=d3.interpolate({startAngle:a.oldStartAngle-1e-6,endAngle:a.oldEndAngle+1e-6},{startAngle:a.startAngle-1e-6,endAngle:a.endAngle+1e-6});return function(a){var c=b(a);return panel_pie.prototype.arc(c)}},panel_pie.prototype.textTween=function(a){var b=(a.oldStartAngle+a.oldEndAngle-Math.PI)/2,c=(a.startAngle+a.endAngle-Math.PI)/2,d=d3.interpolateNumber(b,c);return function(a){var b=d(a);return"translate("+Math.cos(b)*panel_pie.prototype.textRadius+","+Math.sin(b)*panel_pie.prototype.textRadius+")"}},panel_pie.prototype.tickTween=function(a){var b=(a.oldStartAngle+a.oldEndAngle)/2,c=(a.startAngle+a.endAngle)/2,d=d3.interpolateNumber(b,c);return function(a){var b=d(a);return"rotate("+b*(180/Math.PI)+")"}},panel_pie.prototype.preUpdate=function(a){var b=this;a.direction===-1?(b.arc_group.selectAll("path").filter(function(b){return b.id!==a.toId}).on("click",null).remove(),b.label_group.selectAll("line, .gPieTick").filter(function(b){return b.id!==a.toId}).remove()):1===a.direction&&(b.arc_group.selectAll("path").on("click",null).remove(),b.label_group.selectAll("line, .gPieTick").remove(),b.arc_group.selectAll("path").data([1],!1).enter().append("svg:path").attr("class","bar bordered darkenable").attr("fill",global.color(a.fromId)).attr("d",b.arc({startAngle:0,endAngle:2*Math.PI})))},panel_pie.prototype.prepareData=function(a,b,c){var d=this,e=global.baseLevels[d.panelSide][this.dimToShow].length;b.sort(d.cmp);for(var f=d3.layout.pie().sort(d.cmp).value(function(a){return d.valueToShow(a)})(b),g=0,h=0,i=b.length;h<i;h++)g+=d.valueToShow(b[h]);f.filter(function(a){return a.value>0});for(var j=0,k=-9999,l=c.direction===-1&&void 0!==a?global.getFromArrayByProperty(a,"id",c.toId):null,m=l?l.endAngle-l.startAngle:0,n=l?l.startAngle:0,o=0,p=!1,h=0,i=f.length;h<i;h++){var q=f[h],r=q.data;q.id=r.dims[0].id,q.uniqueId=e+"L"+q.id,q.name=r.dims[0].name.trim(),q.value=d.valueToShow(r),q.percentage=(q.value/g*100).toFixed(1),q.tooltip=d.getTooltip(q);var s=(q.startAngle+q.endAngle-Math.PI)/2,t=Math.cos(s)*d.textRadius,u=Math.sin(s)*d.textRadius;if((j<0!=t<0||Math.abs(k-u)>d.requiredDifferenceForX)&&q.percentage>d.labelMinValue?(j=t,k=u,q.isTickRequired=!0):q.isTickRequired=!1,c.direction===-1)q.oldStartAngle=n,q.oldEndAngle=n+m*q.value/g,n=q.oldEndAngle;else if(1===c.direction)p?(q.oldStartAngle=2*Math.PI,q.oldEndAngle=2*Math.PI):(q.oldStartAngle=0,q.oldEndAngle=0),q.id===c.fromId&&(q.oldEndAngle=2*Math.PI,p=!0);else{var v=void 0!==a?global.getFromArrayByProperty(a,"id",q.id):void 0;v?(n=v.startAngle,o=v.endAngle):n=o,q.oldStartAngle=n,q.oldEndAngle=o}}return f},panel_pie.prototype.update=function(a,b){var c=this;c.data=a||c.data,b=b||{dim:-1,direction:0},c.valFraction&&c.meta.indicators[c.valToShow].fraction.hide&&(c.valFraction=!1),!c.valFraction&&c.meta.indicators[c.valToShow].value.hide&&(c.valFraction=!0),c.valMultiplier=isNaN(parseFloat(c.meta.indicators[c.valToShow].fraction.multiplier))?1:parseFloat(c.meta.indicators[c.valToShow].fraction.multiplier);var d=global.getAnimDuration(-1,c.panelId);c.data.rows.length>c.maxEntries?(c.panic(!0,"<html>A panel nem képes "+c.data.rows.length+" értéket megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+c.maxEntries+".</html>"),c.preparedData=void 0):(c.preparedData=c.prepareData(c.preparedData,c.data.rows,b),c.preparedData.length>0&&!isNaN(c.preparedData[0].percentage)?(c.panic(!1),c.drawPie(c.preparedData,d),c.drawLabels(c.preparedData,d)):(c.panic(!0,"<html>A változó értéke<br />minden dimenzióban 0.</html>"),c.preparedData=[]));var e=c.meta.indicators[c.valToShow];c.titleBox.update(c.valToShow,e.caption,e.value.unit,e.fraction.unit,c.valFraction,d)},panel_pie.prototype.drawPie=function(a,b){var c=this,d=c.arc_group.selectAll("path").data(a,function(a){return a.uniqueId});d.enter().append("svg:path").attr("class","bar bordered darkenable listener").attr("fill",function(a){return global.color(a.id)}).on("click",function(a){c.drill(a)}),d.exit().on("click",null).remove(),d.transition().duration(b).attrTween("d",c.pieTween)},panel_pie.prototype.drawLabels=function(a,b){var c=this,d=c.label_group.selectAll("line").data(a,function(a){return a.uniqueId});d.enter().append("svg:line").attr("class","pieTicks").attr("x1",0).attr("x2",0).attr("y1",-c.radius-3).attr("y2",-c.radius-8).attr("transform",function(a){return"rotate("+(a.startAngle+a.endAngle)/2*(180/Math.PI)+")"}),d.transition().duration(b).attrTween("transform",c.tickTween).style("opacity",function(a){return a.isTickRequired?1:0}),d.exit().remove();var e=c.label_group.selectAll("g").data(c.preparedData,function(a){return a.uniqueId}),f=e.enter().append("svg:g").attr("class","gPieTick").attr("transform",function(a){return"translate("+Math.cos((a.startAngle+a.endAngle-Math.PI)/2)*c.textRadius+","+Math.sin((a.startAngle+a.endAngle-Math.PI)/2)*c.textRadius+")"});f.append("svg:text").attr("class","value pieTickValue"),f.append("svg:text").attr("class","units pieTickUnit"),e.select("text.pieTickValue").attr("dy",function(a){return global.valueInRange((a.startAngle+a.endAngle)/2,Math.PI/2,1.5*Math.PI)?5:-7}).attr("text-anchor",function(a){return(a.startAngle+a.endAngle)/2.001<Math.PI?"beginning":"end"}).text(function(a){return a.percentage+"%"}),e.select("text.pieTickUnit").attr("dy",function(a){return global.valueInRange((a.startAngle+a.endAngle)/2,Math.PI/2,1.5*Math.PI)?17:5}).attr("text-anchor",function(a){return(a.startAngle+a.endAngle)/2.001<Math.PI?"beginning":"end"}).text(function(a){return a.name}),e.exit().remove(),e.transition().duration(b).attrTween("transform",c.textTween).style("opacity",function(a){return a.isTickRequired?1:0}),global.cleverCompress(c.label_group.selectAll(".pieTickUnit"),140,1,1.5,!1)},panel_pie.prototype.drill=function(a){var b=this;global.tooltip.kill();var c={dim:b.dimToShow,direction:void 0===a?1:-1,toId:void 0===a?void 0:a.id,toName:void 0===a?void 0:a.name};b.mediator.publish("drill",c)},panel_pie.prototype.doChangeValue=function(a,b,c){var d=this;void 0!==a&&a!==d.panelId||(void 0!==b&&(d.valToShow=b===-1?(d.valToShow+1)%d.meta.indicators.length:b,d.actualInit.val=d.valToShow),void 0!==c&&(d.valFraction=c===-1?!d.valFraction:c,d.actualInit.ratio=d.valFraction),d.update())},panel_pie.prototype.doChangeDimension=function(a,b){var c=this;a===c.panelId&&(c.dimToShow=b,c.actualInit.dim=c.dimToShow,c.mediator.publish("register",c,c.panelId,[c.dimToShow],c.preUpdate,c.update),global.tooltip.kill(),this.mediator.publish("drill",{dim:-1,direction:0,toId:void 0}))};