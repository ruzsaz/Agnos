"use strict";function panel_table2d(f){var d=this;this.constructorName="panel_table2d";this.defaultInit={group:0,position:undefined,dimr:0,dimc:1,val:0,multiplier:1,ratio:false};this.actualInit=global.combineObjects(d.defaultInit,f);Panel.call(d,d.actualInit,global.mediators[d.actualInit.group],false,0,0);this.valMultiplier=1;this.dimRToShow=d.actualInit.dimr;this.dimCToShow=d.actualInit.dimc;this.valToShow=d.actualInit.val;this.valMultiplier=d.actualInit.multiplier;this.valFraction=d.actualInit.ratio;this.dimR=(d.dimRToShow<=d.dimCToShow)?0:1;this.dimC=(d.dimRToShow<d.dimCToShow)?1:0;this.preparedData=[];this.maxEntries=global.maxEntriesIn2D;this.maxEntries1D=global.maxEntriesIn1D;d.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("mouseover",function(){d.hoverOn(this,0)}).on("mouseout",function(){d.hoverOff()}).on("click",function(){d.drill(d.dimR)}).append("svg:rect").attr("width",d.tableLeftMargin+d.tableHeadWidth+d.tableElementGap).attr("height",d.h);d.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("mouseover",function(){d.hoverOn(this,1)}).on("mouseout",function(){d.hoverOff()}).on("click",function(){d.drill(d.dimC)}).append("svg:rect").attr("x",d.tableLeftMargin+d.tableHeadWidth+d.tableElementGap).attr("width",d.w-d.tableLeftMargin+d.tableHeadWidth+d.tableElementGap).attr("height",d.h);var c=d.svg.insert("svg:g",".title_group").attr("class","svgTableHolder").attr("transform","translate("+d.tableLeftMargin+","+d.tableTopMargin+")");this.gRowHeads=c.append("svg:svg").attr("x",0).attr("y",d.tableHeadHeight+d.tableElementGap).attr("width",d.tableHeadWidth).attr("height",d.tableHeight).attr("viewBox","0 0 "+d.tableHeadWidth+" "+d.tableHeight);this.gColumnHeads=c.append("svg:svg").attr("x",d.tableHeadWidth+d.tableElementGap).attr("y",0).attr("width",d.tableWidth).attr("height",d.tableHeadHeight).attr("viewBox","0 0 "+d.tableWidth+" "+d.tableHeadHeight);this.gTable=c.append("svg:svg").attr("x",d.tableHeadWidth+d.tableElementGap).attr("y",d.tableHeadHeight+d.tableElementGap).attr("width",d.tableWidth).attr("height",d.tableHeight).attr("viewBox","0 0 "+d.tableWidth+" "+d.tableHeight);var a=function(){var h=this.scrollTop;var g=d.gTable.attr("viewBox").split(" ");d.gRowHeads.attr("viewBox","0 "+h+" "+d.tableHeadWidth+" "+d.tableHeight);d.gTable.attr("viewBox",g[0]+" "+h+" "+d.tableWidth+" "+d.tableHeight)};var e=function(){var h=this.scrollLeft;var g=d.gTable.attr("viewBox").split(" ");d.gColumnHeads.attr("viewBox",h+" 0 "+d.tableWidth+" "+d.tableHeadHeight);d.gTable.attr("viewBox",h+" "+g[1]+" "+d.tableWidth+" "+d.tableHeight)};this.horizontalScrollbar=new SVGScrollbar(d3.select(d.panelId),true,d.tableWidth,e);d.horizontalScrollbar.setPosition(d.tableHeadWidth+d.tableLeftMargin+d.tableElementGap,400-d.tableBottomMargin-global.scrollbarWidth);this.verticalScrollbar=new SVGScrollbar(d3.select(d.panelId),false,d.tableHeight,a);d.verticalScrollbar.setPosition(600-d.tableLeftMargin-global.scrollbarWidth,d.tableHeadHeight+d.tableTopMargin+d.tableElementGap);var b;b=d.mediator.subscribe("changeValue",function(i,h,g){d.doChangeValue(i,h,g)});d.mediatorIds.push({channel:"changeValue",id:b.id});b=d.mediator.subscribe("changeDimension",function(g,h,i){d.doChangeDimension(g,h,i)});d.mediatorIds.push({channel:"changeDimension",id:b.id});d.mediator.publish("register",d,d.panelId,[d.dimRToShow,d.dimCToShow],d.preUpdate,d.update,d.getConfig)}panel_table2d.prototype=global.subclassOf(Panel);panel_table2d.prototype.tableHeadWidth=120;panel_table2d.prototype.tableHeadHeight=20;panel_table2d.prototype.tableElementGap=4;panel_table2d.prototype.tableLeftMargin=40;panel_table2d.prototype.tableTopMargin=70;panel_table2d.prototype.tableBottomMargin=15;panel_table2d.prototype.tableWidth=600-2*(panel_table2d.prototype.tableLeftMargin+panel_table2d.prototype.tableElementGap)-panel_table2d.prototype.tableHeadWidth-global.scrollbarWidth;panel_table2d.prototype.tableHeight=400-panel_table2d.prototype.tableTopMargin-panel_table2d.prototype.tableHeadHeight-panel_table2d.prototype.tableBottomMargin-global.scrollbarWidth-2*panel_table2d.prototype.tableElementGap;panel_table2d.prototype.tableSpacingVerical=panel_table2d.prototype.tableHeight/15;panel_table2d.prototype.tableSpacingHorizontal=panel_table2d.prototype.tableWidth/7;panel_table2d.prototype.valueToShow=function(c){var a=this;if(c!==undefined&&c.vals!==undefined){var b=(a.valFraction)?a.valMultiplier*c.vals[a.valToShow].sz/c.vals[a.valToShow].n:c.vals[a.valToShow].sz;if(isNaN(parseFloat(b))){b=0}return b}else{return null}};panel_table2d.prototype.getTooltip=function(a,d){var b=this;var c;if(d===undefined){c=b.createTooltip([{name:b.meta.dimensions[b.dimRToShow].description,value:(a.name)?a.name:"Nincs adat"}],[])}else{if(a===undefined){c=b.createTooltip([{name:b.meta.dimensions[b.dimCToShow].description,value:(d.name)?d.name:"Nincs adat"}],[])}else{c=b.createTooltip([{name:b.meta.dimensions[b.dimRToShow].description,value:(a.name)?a.name:"Nincs adat"},{name:b.meta.dimensions[b.dimCToShow].description,value:(d.dimCName)?d.dimCName:"Nincs adat"}],[{name:b.meta.indicators[b.valToShow].description,value:d.value,dimension:((b.valFraction)?b.meta.indicators[b.valToShow].fraction.unit:b.meta.indicators[b.valToShow].value.unit)}])}}return c};panel_table2d.prototype.getCmpFunction=function(){var a=this;return function(d,c){return(d.dims[a.dimR].name+":"+d.dims[a.dimC].name).localeCompare(c.dims[a.dimR].name+":"+c.dims[a.dimC].name)}};panel_table2d.prototype.simpleCmp=function(d,c){return d.name.localeCompare(c.name)};panel_table2d.prototype.preUpdate=function(a){var b=this;if(a.dim===b.dimRToShow){if(a.direction===-1){b.gRowHeads.selectAll(".svgRowHead").filter(function(c){return(c.id!==a.toId)}).remove();b.gTable.selectAll(".svgTableRow").filter(function(c){return(c.id!==a.toId)}).remove()}else{if(a.direction===1){if((global.baseLevels[b.panelSide])[b.dimRToShow].length+2!==b.meta.dimensions[b.dimRToShow].levels.length){b.gRowHeads.selectAll(".svgRowHead").remove();b.gTable.selectAll(".svgTableRow").remove()}}}}else{if(a.dim===b.dimCToShow){if(a.direction===-1){b.gColumnHeads.selectAll(".svgColumnHead").filter(function(c){return(c.id!==a.toId)}).remove();b.gTable.selectAll(".svgTableCell").filter(function(c){return(c.dimCId!==a.toId)}).remove()}else{if(a.direction===1){if((global.baseLevels[b.panelSide])[b.dimCToShow].length+2!==b.meta.dimensions[b.dimCToShow].levels.length){b.gColumnHeads.selectAll(".svgColumnHead").remove();b.gTable.selectAll(".svgTableRow").remove()}}}}}};panel_table2d.prototype.prepareData=function(h,A,j){var p=this;var a=(global.baseLevels[p.panelSide])[p.dimRToShow].length;var o=(global.baseLevels[p.panelSide])[p.dimCToShow].length;A.sort(p.getCmpFunction());var w=[];var I=[];var z;var q=-1;for(var F=0;F<A.length;F++){var G=A[F];var C=G.dims[p.dimC];var m=global.positionInArrayByProperty(w,"id",C.id);if(m===-1){m=w.length;var l={index:m,oldColumnIndex:m,id:C.id,uniqueId:o+"L"+C.id,knownId:C.knownId,name:C.name.trim(),parentId:C.parentId,tooltip:p.getTooltip(undefined,C),startOpacity:0};w.push(l)}}w.sort(p.simpleCmp);for(var F=0,D=w.length;F<D;F++){w[F].index=F;w[F].oldColumnIndex=F}for(var F=0;F<A.length;F++){var G=A[F];if(G.dims[p.dimR].id!==z){var n=G.dims[p.dimR];z=n.id;q++;var g={index:q,oldRowIndex:q,id:z,uniqueId:a+"L"+z,name:n.name.trim(),values:[],tooltip:p.getTooltip(n),startOpacity:0};I.push(g)}var C=G.dims[p.dimC];var m=global.positionInArrayByProperty(w,"id",C.id);var g=I[I.length-1];var H=p.valueToShow(G);var t={index:m,oldColumnIndex:m,value:H,dimCId:C.id,dimCUniqueId:o+"L"+C.id,dimCName:C.name.trim(),startOpacity:1};t.tooltip=p.getTooltip(n,t);g.values.push(t)}if(h&&j.dim===p.dimRToShow&&j.direction===-1){var c=global.getFromArrayByProperty(h.dataArray,"id",j.toId).index;for(var u=0,b=I.length;u<b;u++){I[u].oldRowIndex=c;I[u].startOpacity=(1/b)+0.2}}else{if(h&&j.dim===p.dimRToShow&&j.direction===1){var k=(h.dataArray.length-1)/2;var B=global.getFromArrayByProperty(I,"id",j.fromId).index;for(var u=0,b=I.length;u<b;u++){I[u].oldRowIndex=(I[u].index-B)*5+k;I[u].startOpacity=(I[u].index===B)?1:0}}else{if(h&&j.dim===p.dimCToShow&&j.direction===-1){var E=global.getFromArrayByProperty(h.dimCArray,"id",j.toId);var y=(E)?E.index:null;for(var s=0,x=w.length;s<x;s++){w[s].oldColumnIndex=y;w[s].startOpacity=(1/x)+0.2;for(var u=0,b=I.length;u<b;u++){var f=I[u].values;if(f[s]!==null&&f[s]!==undefined){f[s].oldColumnIndex=y;f[s].startOpacity=(1/x)+0.2}}}}else{if(h&&j.dim===p.dimCToShow&&j.direction===1){var k=(h.dimCArray.length-1)/2;var e=global.getFromArrayByProperty(w,"id",j.fromId).index;for(var u=0,b=I.length;u<b;u++){I[u].startOpacity=1}for(var s=0,x=w.length;s<x;s++){w[s].oldColumnIndex=(w[s].index-e)*5+k;w[s].startOpacity=(w[s].index===e)?1:0;for(var u=0,b=I.length;u<b;u++){var f=I[u].values;if(f[s]!==null&&f[s]!==undefined){f[s].oldColumnIndex=(f[s].index-e)*5+k;f[s].startOpacity=(f[s].index===e)?1:0}}}}}}}return{dataArray:I,dimCArray:w}};panel_table2d.prototype.update=function(e,b){var d=this;d.data=e||d.data;b=b||{dim:-1,direction:0};d.valMultiplier=(isNaN(parseFloat(d.meta.indicators[d.valToShow].fraction.multiplier)))?1:parseFloat(d.meta.indicators[d.valToShow].fraction.multiplier);if(d.valFraction&&d.meta.indicators[d.valToShow].fraction.hide){d.valFraction=false}if(!d.valFraction&&d.meta.indicators[d.valToShow].value.hide){d.valFraction=true}var c=global.getAnimDuration(-1,d.panelId);if(d.data.rows.length>d.maxEntries){d.panic(true,"<html>A panel nem képes "+d.data.rows.length+" értéket megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+d.maxEntries+".</html>");d.preparedData=undefined}else{d.preparedData=d.prepareData(d.preparedData,d.data.rows,b);var f=Math.max(d.preparedData.dimCArray.length,Math.ceil(d.data.rows.length/d.preparedData.dimCArray.length));if(f>d.maxEntries1D){d.horizontalScrollbar.set(0,global.colorValue(d.valToShow),c);d.verticalScrollbar.set(0,global.colorValue(d.valToShow),c);d.panic(true,"<html>A panel nem képes "+f+" értéket egy dimenzió mentén megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+d.maxEntries1D+".</html>");d.preparedData=undefined}else{d.panic(false);d.drawRowHeaders(d.preparedData,c);d.drawColumnHeaders(d.preparedData,c);d.drawCells(d.preparedData,c);d.horizontalScrollbar.set(d.preparedData.dimCArray.length*d.tableSpacingHorizontal,global.colorValue(d.valToShow),c);d.verticalScrollbar.set(d.preparedData.dataArray.length*d.tableSpacingVerical,global.colorValue(d.valToShow),c)}}var a=d.meta.indicators[d.valToShow];d.titleBox.update(d.valToShow,a.caption,a.value.unit,a.fraction.unit,d.valFraction,c)};panel_table2d.prototype.drawCells=function(f,c){var b=this;var e=b.gTable.selectAll(".svgTableRow").data(f.dataArray,function(g){return g.name});e.enter().append("svg:g").attr("class","svgTableRow alterColored").attr("transform",function(g){return"translate(0,"+(g.oldRowIndex*b.tableSpacingVerical)+")"}).attr("opacity",function(g){return g.startOpacity});e.attr("parity",function(g){return g.index%2}).transition().duration(c).attr("transform",function(g){return"translate(0, "+g.index*b.tableSpacingVerical+")"}).attr("opacity",1);e.exit().remove();var a=e.selectAll(".svgTableCell").data(function(g){return g.values},function(g){return g.dimCName});var d=a.enter().append("svg:g").attr("class","svgTableCell alterColored").attr("transform",function(g){return"translate("+(g.oldColumnIndex*b.tableSpacingHorizontal)+",0)"}).attr("opacity",function(g){return g.startOpacity});d.append("svg:rect").attr("class","backgroundRect").attr("width",b.tableSpacingHorizontal).attr("height",b.tableSpacingVerical);d.append("svg:text").attr("x",b.tableSpacingHorizontal/2).attr("y",b.tableSpacingVerical/2).attr("dy",".35em");a.exit().remove();a.select("text").attr("opacity",function(g){return(global.cleverRound5(g.value)===d3.select(this).text())?1:0}).text(function(g){return global.cleverRound5(g.value)}).transition().duration(c).attr("opacity",1);a.attr("parity",function(g){return g.index%2}).transition().duration(c).attr("transform",function(g){return"translate("+(g.index*b.tableSpacingHorizontal)+",0)"}).attr("opacity",1)};panel_table2d.prototype.drawRowHeaders=function(e,c){var b=this;var d=b.gRowHeads.selectAll(".svgRowHead").data(e.dataArray,function(f){return f.uniqueId+f.name});var a=d.enter().append("svg:g").attr("class","svgRowHead listener alterColored").on("click",function(f){b.drill(b.dimR,f)}).attr("transform",function(f){return"translate(0,"+(f.oldRowIndex*b.tableSpacingVerical)+")"}).attr("opacity",function(f){return f.startOpacity});a.append("svg:rect").attr("class","backgroundRect").attr("width",b.tableHeadWidth).attr("height",b.tableSpacingVerical);a.append("svg:text").attr("opacity",1).attr("class","svgRowHeadLabel svgTableHeadLabel").attr("y",b.tableSpacingVerical/2).attr("x",0).attr("dy","0.35em").attr("dx",".26em").text(function(f){return f.name});d.exit().on("click",null).remove();d.attr("parity",function(f){return f.index%2}).classed("darkenable",false).transition().duration(c).attr("opacity",1).attr("transform",function(f){return"translate(0, "+f.index*b.tableSpacingVerical+")"}).each("end",Panel.prototype.classedDarkenable);global.cleverCompress(b.gRowHeads.selectAll("text"),b.tableHeadWidth,0.94,1.4)};panel_table2d.prototype.drawColumnHeaders=function(e,b){var a=this;var d=a.gColumnHeads.selectAll(".svgColumnHead").data(e.dimCArray,function(f){return f.uniqueId+f.name});var c=d.enter().append("svg:g").attr("class","svgColumnHead alterColored listener").on("click",function(f){a.drill(a.dimC,f)}).attr("transform",function(f){return"translate("+(f.oldColumnIndex*a.tableSpacingHorizontal)+",0)"}).attr("opacity",function(f){return f.startOpacity});c.append("svg:rect").attr("class","backgroundRect").attr("width",a.tableSpacingHorizontal).attr("height",a.tableHeadHeight);c.append("svg:text").attr("opacity",1).attr("class","svgColumnHeadLabel svgTableHeadLabel").attr("x",a.tableSpacingHorizontal/2).attr("y",a.tableHeadHeight/2).attr("dy","0.35em").text(function(f){return f.name});d.exit().on("click",null).remove();d.attr("parity",function(f){return f.index%2}).classed("darkenable",false).transition().duration(b).attr("transform",function(f){return"translate("+(f.index*a.tableSpacingHorizontal)+",0)"}).attr("opacity",1).each("end",Panel.prototype.classedDarkenable);global.cleverCompress(a.gColumnHeads.selectAll("text"),a.tableSpacingHorizontal,0.85,1.4)};panel_table2d.prototype.drill=function(b,c){global.tooltip.kill();var a={dim:(b===this.dimR)?this.dimRToShow:this.dimCToShow,direction:(c===undefined)?1:-1,toId:(c===undefined)?undefined:c.id,toName:(c===undefined)?undefined:c.name};this.mediator.publish("drill",a)};panel_table2d.prototype.doChangeValue=function(a,d,b){var c=this;if(a===undefined||a===c.panelId){if(d!==undefined){c.valToShow=(d===-1)?(c.valToShow+1)%c.meta.indicators.length:d;c.actualInit.val=c.valToShow}if(b!==undefined){c.valFraction=(b===-1)?!c.valFraction:b;c.actualInit.ratio=c.valFraction}c.update()}};panel_table2d.prototype.doChangeDimension=function(a,b,d){var c=this;if(a===c.panelId){if(d===0){c.dimRToShow=b;c.actualInit.dimr=c.dimRToShow}else{c.dimCToShow=b;c.actualInit.dimc=c.dimCToShow}c.dimR=(c.dimRToShow<=c.dimCToShow)?0:1;c.dimC=(c.dimRToShow<c.dimCToShow)?1:0;c.mediator.publish("register",c,c.panelId,[c.dimRToShow,c.dimCToShow],c.preUpdate,c.update);global.tooltip.kill();c.mediator.publish("drill",{dim:-1,direction:0,toId:undefined})}};