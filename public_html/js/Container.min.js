"use strict";function Container(){this.dataDirector=[];var e=this;var d=d3.select("body").append("html:div").attr("id","topdiv");this.mainToolbar=d.append("html:div").attr("class","mainToolbar").attr("id","mainToolbar");$("#mainToolbar").load("mainToolbar.html?ver="+version);d.append("html:div").attr("id","progressDiv");for(var c=0;c<2;c++){var b=d.append("html:div").attr("id","scrollPaneP"+c).append("html:div").attr("id","cutter"+c).append("html:div").attr("id","container"+c).attr("class","container").style(global.getStyleForScale(1,0,0));b.append("html:div").attr("id","headPanelP"+c).attr("class","panel double")}d3.select("#container0").classed("activeSide",true);this.isSideInUse=[];$(window).resize(function(){e.onResize()});var a=parseInt(d3.select("#topdiv").style("width"));global.panelNumberOnScreen=parseInt((a/global.panelWidth)+0.5);this.panelState=0;global.initGlobals(function(){e.initSide(0);e.initSide(1);e.onResize();e.tableBaseOffset=parseInt(d3.select("#headPanelP0").style("margin-top"))+parseInt(d3.select("#headPanelP0").style("margin-bottom"))+parseInt(d3.select("#searchP0").style("margin-top"))+parseInt(d3.select("#searchP0").style("margin-bottom"))+parseInt(d3.select("#searchP0").style("height"))+parseInt(d3.select(".divTableBase").style("margin-bottom"))+parseInt(d3.select(".tableScrollPane").style("padding-top"))+parseInt(d3.select(".tableScrollPane").style("padding-bottom"));var g=location.href.split("#")[1];if(g){try{var f=JSON.parse(LZString.decompressFromEncodedURIComponent(g));e.navigateTo(f)}catch(h){console.err("A bookmarkban hivatkozott objektum sérült, dekódolni nem lehet.")}}})}Container.prototype.switchPanels=function(){this.panelState=(this.panelState+1)%4;var a=Math.abs((this.panelState/2)-1);this.resizeContainers(global.selfDuration,a,false,false,true,global.panelNumberOnScreen);d3.select("#container0").classed("activeSide",(this.panelState!==2));d3.select("#container1").classed("activeSide",(this.panelState!==0));global.mainToolbar_refreshState()};Container.prototype.magnify=function(a){global.panelNumberOnScreen=Math.min(global.maxPanelCount,Math.max(1,global.panelNumberOnScreen+a));global.mainToolbar_refreshState();this.onResize(global.panelNumberOnScreen)};Container.prototype.onResize=function(b){if(b===undefined||b<0){b=global.panelNumberOnScreen}var a=Math.abs((this.panelState/2)-1);this.resizeContainers(global.selfDuration,a,false,true,false,b)};Container.prototype.resizeContainers=function(f,e,c,a,d,b){this.resizeContainer(0,f,e,c,a,d,b);this.resizeContainer(1,f,1-e,c,a,d,b)};Container.prototype.resizeContainer=function(l,c,m,e,o,j,k){var i=this;var n=parseInt(d3.select("#topdiv").style("width"));var q=Math.max(document.documentElement.clientHeight,window.innerHeight||0);var f=0;if(o){d3.select("#scrollPaneP"+l).style("width",(n*m)+"px");f=parseInt(document.getElementById("scrollPaneP"+l).clientWidth)}if(j){d3.select("#scrollPaneP"+l).transition().duration(c).style("width",(n*m)+"px");f=n*m}if(e){f=parseInt(document.getElementById("scrollPaneP"+l).clientWidth)}var a=parseInt($(".panel").css("margin-top"))+parseInt($(".panel").css("border-top-width"));var b=global.panelWidth+2*a;var d=Math.max(parseInt(f/b),1);if(k>0){d=k}else{if(m>0){global.panelNumberOnScreen=d/m}}var h=f/(d*b);d3.select("#scrollPaneP"+l+" .HeadPanel_Browser .tableScrollPane").style("max-height",Math.max(100,parseInt(((q-global.mainToolbarHeight)/h)-this.tableBaseOffset))+"px");d3.select("body").style("width",null);var p=function(){if(!e){i.resizeContainer(l,c/10,m,true,false,false,d)}else{if(c!==0){i.resizeContainer(l,0,m,true,false,false,d)}}};if(global.mediators[0]){global.mediators[l].publish("resize",c,d,h,p)}d3.select("#container"+l).transition().duration(c).style({width:parseInt((f/h)+20)+"px"}).style(global.getStyleForScale(h,0,0));var g=parseInt(d3.select("#container"+l).style("height"))*h;d3.select("#cutter"+l).transition().duration(c).style("height",g+"px");if(h>0){global.scaleRatio=h}};Container.prototype.newReport=function(a,c,b){global.mediators[a].remove("killListeners");this.isSideInUse[a]=true;global.facts[a]=new Fact(c,a,this.newReportReady,b)};Container.prototype.navigateTo=function(c){for(var b=0;b<2;b++){var d=c.p[b];if(d.v){var a=global.getFromArrayByProperty(global.superMeta,"name",d.c);d.v=global.minifyInits(d.v,true).split(";");this.newReport(b,a,d)}}if(c.d!==0){global.mediators[0].publish("changepanels");if(c.d===1){global.mediators[0].publish("changepanels")}}};Container.prototype.newReportReady=function(side,reportMeta){for(var i=0,iMax=reportMeta.visualization.length;i<iMax;i++){var initString=reportMeta.visualization[i].toLowerCase();if(initString.indexOf("})")>-1){initString=initString.replace("})",", group: "+side+"})");initString=initString.replace("({, ","({")}else{if(initString.indexOf("()")>-1){initString=initString.replace("()","({group: "+side+"})")}else{initString=""}}eval("new "+initString)}global.mediators[side].publish("killPanel","#panel"+side+"P-1");new HeadPanel_Report({group:side},reportMeta);global.mediators[side].publish("drill",{dim:-1,direction:0});global.mainToolbar_refreshState()};Container.prototype.initSide=function(a){var b=this;if(global.mediators===undefined||global.mediators[a]===undefined){global.mediators[a]=new Mediator()}global.mediators[a].subscribe("newreport",function(d,c){b.newReport(d,c)});global.mediators[a].subscribe("changepanels",function(c){b.switchPanels(c)});global.mediators[a].subscribe("killside",function(c){b.killSide(c)});global.mediators[a].subscribe("magnify",function(c){b.magnify(c)});global.mediators[a].subscribe("addPanel",function(c){b.addPanel(a,c)});global.mediators[a].subscribe("save",function(){b.save(a)});b.isSideInUse[a]=false;new Draglayer(a,global.mediators[a]);new HeadPanel_Browser({group:a},global.superMeta);this.dataDirector[a]=new DataDirector(a,global.mediators[a])};Container.prototype.killSide=function(a){if(this.panelState/2===a&&this.isSideInUse[a]){global.mediators[a].publish("killListeners");global.mediators[a].publish("killPanel",undefined);global.mediators[a].remove("changeValue");global.mediators[a].remove("changeDimension");global.mediators[a].remove("changepanels");global.mediators[a].remove("drill");global.mediators[a].remove("killside");global.mediators[a].remove("newreport");global.mediators[a].remove("killListeners");global.mediators[a].remove("killPanel");global.mediators[a].remove("resize");global.mediators[a].remove("magnify");global.mediators[a].remove("register");global.mediators[a].remove("addDrag");global.mediators[a].remove("addPanel");global.mediators[a].remove("getConfig");global.mediators[a].remove("save");global.baseLevels[a]=[];global.facts[a]=null;this.dataDirector[a]=undefined;this.initSide(a);this.onResize();global.mainToolbar_refreshState()}};Container.prototype.addPanel=function(c,a){if(this.panelState/2===c&&this.isSideInUse[c]){var b=this.dataDirector[c].getFirstFreeIndex();var d=this.dataDirector[c].guessDimension();if(b>=0){switch(a){case"piechartpanel":new panel_pie({group:c,position:b,dim:d});break;case"mappanel":new panel_map({group:c,position:b,dim:d,poi:false});break;case"poimappanel":new panel_map({group:c,position:b,dim:d,poi:true});break;case"barpanel":new panel_barline({group:c,position:b,dim:d});break;case"strechedbarpanel":new panel_barline({group:c,position:b,streched:true,valbars:[0],dim:d});break;case"linepanel":new panel_barline({group:c,position:b,valbars:[],vallines:[0],dim:d});break;case"markedlinepanel":new panel_barline({group:c,position:b,valbars:[],vallines:[0],symbols:true,dim:d});break;case"bar2panel":new panel_bar2d({group:c,position:b,dimx:d,dimy:this.dataDirector[c].guessDimension(d)});break;case"strechedbar2panel":new panel_bar2d({group:c,position:b,dimx:d,dimy:this.dataDirector[c].guessDimension(d),streched:true});break;case"horizontalbarpanel":new panel_horizontalbar({group:c,position:b,centered:false,dim:d});break;case"fixedhorizontalbarpanel":new panel_horizontalbar({group:c,position:b,centered:true,dim:d});break;case"Panel_Table1D":new panel_table1d({group:c,position:b,dim:d});break;case"Panel_Table2D":new panel_table2d({group:c,position:b,dimr:d,dimc:this.dataDirector[c].guessDimension(d)});break;case"top10Barpanel":new panel_barline({group:c,position:b,dim:d,top10:true});break;case"top10Linepanel":new panel_barline({group:c,position:b,valbars:[],vallines:[0],dim:d,symbols:true,top10:true});break}}global.mainToolbar_refreshState();global.mediators[c].publish("drill",{dim:-1,direction:0})}};Container.prototype.save=function(b){var c=this;if(this.panelState/2===b&&this.isSideInUse[b]){var f="";for(var e=0,a=global.facts[b].reportMeta.dimensions.length;e<a;e++){f=f+"<input class = 'saveCheckBox' type='checkbox' checked/>"+global.facts[b].reportMeta.dimensions[e].caption+"<br>"}global.setDialog("Adatok mentése CSV-ként","<div class='saveStaticText'>Az alábbi dimenziókat alábontva:</div><div class='saveVariableText'>"+f+"</div>","Mégse",function(){global.setDialog()},"Mentés",function(){var d=[];var g=document.getElementsByClassName("saveCheckBox");for(var i=0,h=g.length;i<h;i++){d.push((g[i].checked)?1:0)}c.saveAsCsv(b,d)})}};Container.prototype.saveAsCsv=function(n,q){var s=global.facts[n].reportMeta;var j=global.baseLevels[n];var a='"'+s.caption+'"\n\n';a+='"Lefúrási szint:"';for(var h=0,g=j.length;h<g;h++){var t=j[h];a+=',"'+s.dimensions[h].caption+':","'+((t.length===0)?s.dimensions[h].top_level_caption:t[t.length-1].name)+'"\n'}var r="";var e="";for(var m=0,p=j.length;m<p;m++){var c="";r+=e;for(var f=0,k=j[m].length;f<k;f++){r+=c+(j[m])[f].id;c=","}e=":"}var o=s.cube_unique_name+";"+r+";"+q.toString().replace(/,/g,":");var b="queries="+window.btoa(o);global.get(global.url.fact,b,function(Q){var E=Q;var J="";var w="";for(var M=0,K=j.length;M<K;M++){if(q[M]===1){J+=w+'"'+s.dimensions[M].caption+'"';w=","}}for(var F=0,H=s.indicators.length;F<H;F++){var z=(s.indicators[F].value.hide)?'"Nem értelmezett"':'"'+(s.indicators[F].caption+" ("+s.indicators[F].value.unit+')"');var y=(s.indicators[F].fraction.hide)?'"Nem értelmezett"':'"'+(s.indicators[F].caption+" ("+s.indicators[F].fraction.unit+')"');J+=w+z+","+y;w=","}J=J+"\n";var N=[];for(var F=0,H=s.indicators.length;F<H;F++){N.push((isNaN(parseFloat(s.indicators[F].fraction.multiplier)))?1:parseFloat(s.indicators[F].fraction.multiplier))}for(var G=0,u=E[0].response.rows.length;G<u;G++){var A=E[0].response.rows[G];var D="";var w="";for(var O=0,P=A.dims.length;O<P;O++){D+=w+'"'+A.dims[O].name+'"';w=","}for(var F=0,H=A.vals.length;F<H;F++){var I=(s.indicators[F].value.hide)?"":A.vals[F].sz;var C=(s.indicators[F].fraction.hide)?"":N[F]*A.vals[F].sz/A.vals[F].n;D+=w+I+","+C;w=","}J=J+D+"\n"}J=a+"\n"+J;var L="Pulzus_"+global.facts[n].reportMeta.caption.replace(/[őóö]/ig,"o").replace(/[űüú]/ig,"u").replace(/[á]/ig,"a").replace(/[é]/ig,"e").replace(/[í]/ig,"i").replace(/[ŐÖÓ]/ig,"O").replace(/[ŰÚÜ]/ig,"U").replace(/[Á]/ig,"A").replace(/[É]/ig,"E").replace(/[Í]/ig,"I").replace(/[^a-z0-9]/gi,"_")+".csv";var l=new Blob([J],{type:"text/csv; charset=utf-8;"});var B=document.createElement("a");if(navigator.msSaveBlob){navigator.msSaveBlob(l,L);global.setDialog()}else{if(B.download!==undefined){var x=URL.createObjectURL(l);B.setAttribute("href",x);B.setAttribute("download",L);B.style.visibility="hidden";document.body.appendChild(B);B.click();document.body.removeChild(B);global.setDialog()}else{global.setDialog("A fájl mentése sikertelen","<div class='saveStaticText'>A manuális mentéshez a szövegdoboz tartalmát COPY+PASTE-el írd ki egy .csv kiterjesztésű fájlba.</div><textarea id='saveTextArea' wrap='off' cols='80' rows='5'>"+J+"</textarea>","Kijelölés",function(){document.getElementById("saveTextArea").select()},"Tovább",function(){global.setDialog()})}}},false)};