"use strict";var mappanel=panel_map;function panel_map(i){var g=this;this.constructorName="panel_map";this.defaultInit={group:0,position:undefined,dim:0,val:0,ratio:false,domain:[],domainr:[],range:undefined,poi:false};this.actualInit=global.combineObjects(g.defaultInit,i);this.isColorsLocked=(g.actualInit.range!==undefined);Panel.call(g,g.actualInit,global.mediators[g.actualInit.group],true,0,0);if(g.meta.dimensions[g.actualInit.dim].is_territorial!==1){for(var h=0,b=g.meta.dimensions.length;h<b;h++){if(g.meta.dimensions[h].is_territorial===1){g.actualInit.dim=h;break}}}this.valMultiplier=1;this.dimToShow=g.actualInit.dim;this.valToShow=g.actualInit.val;this.valFraction=g.actualInit.ratio;this.isPoiRequired=g.actualInit.poi;this.currentLevel;this.maxDepth=g.meta.dimensions[g.dimToShow].levels.length-1;this.imageCover=Math.min(g.width/g.w,g.height/g.h);this.colorScale=d3.scale.linear().clamp(true);this.colorRange;if(!g.isColorsLocked){g.colorRange=[g.defaultColorMin,global.colorValue(g.valToShow),g.defaultColorMax]}else{g.colorRange=g.actualInit.range;if(g.colorRange.length===2){var a=d3.scale.linear().domain([0,1]).range(g.colorRange)(0.5);g.colorRange[2]=g.colorRange[1];g.colorRange[1]=a}}this.projection=d3.geo.mercator().scale(30000).center([19.5,47.2]).translate([g.w/2,g.height/2+g.margin.top]);this.path=d3.geo.path().projection(g.projection);g.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("click",function(){g.drill()}).on("mouseover",function(){g.hoverOn(this)}).on("mouseout",function(){g.hoverOff()}).append("svg:rect").attr("width",g.w).attr("height",g.h);this.gMapHolder=g.svg.insert("svg:g",".title_group").attr("class","mapHolder");this.gWater=g.svg.insert("svg:g",".title_group").attr("class","mapHolder water noEvents");this.gLabelHolder=g.svg.insert("svg:g",".title_group").attr("class","mapHolder labels noEvents");this.gPoiHolder=g.svg.insert("svg:g",".title_group").attr("class","mapHolder pois");this.gPoiLegend=g.svg.insert("svg:g",".title_group").attr("class","gPoiLegend");this.gLegend=g.svg.insert("svg:g",".title_group").attr("class","legend noEvents");this.mask=g.svg.append("svg:mask").attr("id","maskurl"+g.panelId);var f;f=g.mediator.subscribe("changeValue",function(k,j,d){g.doChangeValue(k,j,d)});g.mediatorIds.push({channel:"changeValue",id:f.id});f=g.mediator.subscribe("changeDimension",function(d,j,k){g.doChangeDimension(d,j)});g.mediatorIds.push({channel:"changeDimension",id:f.id});g.mediator.publish("register",g,g.panelId,[g.dimToShow],g.preUpdate,g.update,g.getConfig);var e=g.path.bounds((topojson.feature(g.topology,g.topoLevel(g.topology.objects.level0)).features)[0]);var c=g.imageCover/Math.max((e[1][0]-e[0][0])/g.w,(e[1][1]-e[0][1])/g.h);g.svg.selectAll(".mapHolder").attr("transform","translate("+g.projection.translate()+")scale("+c+")translate("+-(e[1][0]+e[0][0])/2+","+-(e[1][1]+e[0][1])/2+")");g.gWater.selectAll("path").data(topojson.feature(g.topology,g.topology.objects.viz).features).enter().append("svg:path").attr("class",function(j){return j.geometry.type}).attr("d",g.path).attr("mask","url(#maskurl"+g.panelId+")")}panel_map.prototype=global.subclassOf(Panel);panel_map.prototype.mapLabelSize=10;panel_map.prototype.poiLegendRadius=10;panel_map.prototype.mapLabelOpacity=0.8;panel_map.prototype.legendTicks=7;panel_map.prototype.defaultColorMin="white";panel_map.prototype.defaultColorMax="black";panel_map.prototype.poiLegendWidth=140;panel_map.prototype.poiLegendHeight=30;panel_map.prototype.topology=mapOfHungary;panel_map.prototype.pois=pois;panel_map.prototype.valueToShow=function(c){var a=this;if(c!==undefined&&c.vals!==undefined){var b=(a.valFraction)?a.valMultiplier*c.vals[a.valToShow].sz/c.vals[a.valToShow].n:c.vals[a.valToShow].sz;if(isNaN(parseInt(b))){b=0}return b}else{return null}};panel_map.prototype.getTooltip=function(b){var a=this;return a.createTooltip([{name:a.meta.dimensions[a.dimToShow].description,value:(b.name)?b.name:"Nincs adat"}],[{name:a.meta.indicators[a.valToShow].description,value:b.value,dimension:((a.valFraction)?a.meta.indicators[a.valToShow].fraction.unit:a.meta.indicators[a.valToShow].value.unit)}])};panel_map.prototype.colorLinear=function(a){return(!isNaN(a))?this.colorScale(a):global.colorNA};panel_map.prototype.setColorRange=function(d,e,b){var c=this;var a=(c.valFraction)?c.actualInit.domainr:c.actualInit.domain;if(!(a instanceof Array)||a.length<2){c.colorScale.domain([d,e,b]).range(c.colorRange)}else{if(a.length===2){c.colorScale.domain(a).range([c.colorRange[0],c.colorRange[2]])}else{c.colorScale.domain(a).range(c.colorRange)}}c.colorScale.nice(c.legendTicks)};panel_map.prototype.topoLevel=function(a){switch(a){case 1:return(this.maxDepth>=1)?this.topology.objects.level1:this.topology.objects.level0;break;case 2:return(this.maxDepth>=2)?this.topology.objects.level2:this.topology.objects.level1;break;case 3:return(this.maxDepth>=3)?this.topology.objects.level3:this.topology.objects.level2;break;case 4:return this.topology.objects.level3;break;default:return this.topology.objects.level0;break}};panel_map.prototype.getParent=function(a){if(a.length>0){var e=(a[0].dims[0].knownId!=="N/A")?a[0].dims[0].knownId:(a.length>1)?a[1].dims[0].knownId:undefined;var b;for(var d=0;d<=3;d++){var c=topojson.feature(this.topology,this.topoLevel(d)).features.filter(function(f){return e===f.properties.shapeid});if(c.length>0){b=topojson.feature(this.topology,this.topoLevel(d-1)).features.filter(function(f){return c[0].properties.parent===f.properties.shapeid});break}}}return(b===undefined)?undefined:b[0]};panel_map.prototype.getSelf=function(c){for(var b=0;b<=3;b++){var a=topojson.feature(this.topology,this.topoLevel(b)).features.filter(function(e){return c===e.properties.shapeid});if(a.length>0){break}}return a[0]};panel_map.prototype.isInMultiPolygon=function(b,i,r){var g=false;if(r!==undefined&&r.geometry!==undefined){var o=r.geometry.coordinates;var m=Math.round(b*1000000000)+0.5;var j=Math.round(i*1000000000)+0.5;for(var d=0,h=o.length;d<h;d++){var l=o[d];for(var a=0,f=l.length-1;a<f;a++){var e=Math.round(l[a][0]*1000000000);var n=Math.round(l[a][1]*1000000000);var c=Math.round(l[a+1][0]*1000000000);var k=Math.round(l[a+1][1]*1000000000);if(((k>j)!==(n>j))&&(m<(e-c)*(j-k)/(n-k)+c)){g=!g}}}}return g};panel_map.prototype.scaleModifier=function(e,d,c,b){var a=1;if((this.w/2)+e>c&&(this.h/2)+d>b){a=Math.max((c-this.w/2)/e,(b-this.h/2)/d)}return a};panel_map.prototype.preUpdate=function(b){var e=this;if(b.direction===-1){if(e.isPoiRequired){var c;if(e.data!==undefined){for(var d=0,a=e.data.rows.length;d<a;d++){var f=e.data.rows[d].dims[0];if(f.id===b.toId){var c=e.getSelf(f.knownId);break}}}e.gPoiHolder.selectAll(".gPoi g").filter(function(g){return !e.isInMultiPolygon(g.lon,g.lat,c)}).remove()}e.gMapHolder.selectAll("path").filter(function(g){return(g.id!==b.toId)}).on("click",null).remove();e.mask.selectAll("path").filter(function(g){return(g.id!==b.toId)}).remove()}if(e.dimToShow===b.dim&&e.currentLevel!==e.maxDepth+1){e.gLabelHolder.selectAll(".mapLabel").filter(function(g){return(g.id!==b.toId)}).remove()}};panel_map.prototype.prepareData=function(b){var h=this;if(b.length===0||(b[0].dims[0].knownId==="N/A"&&b.length===1)){return undefined}else{if(h.isPoiRequired){var f=h.w-h.poiLegendWidth-global.legendOffsetX-20;var e=h.h-2*global.legendOffsetY-global.legendHeight-h.pois.length*h.poiLegendHeight-20}var d=(h.currentLevel!==h.maxDepth+1)?h.getParent(b):h.getSelf(b[0].dims[0].knownId);if(d===undefined){return undefined}else{var j=h.path.bounds(d);var c=h.imageCover/Math.max((j[1][0]-j[0][0])/h.w,(j[1][1]-j[0][1])/h.h);var g=topojson.feature(h.topology,h.topoLevel(h.currentLevel)).features.filter(function(k){return d.properties.shapeid===((h.currentLevel===h.maxDepth+1)?k.properties.shapeid:k.properties.parent)});var i=[];var a=h.path.bounds;g.map(function(r){for(var l=0,m=b.length;l<m;l++){if(b[l].dims[0].knownId===r.properties.shapeid){var q=b[l];var k=a(r);var n={};n.geometry=r.geometry;n.properties=r.properties;n.type=r.type;n.id=q.dims[0].id;n.uniqueId=h.currentLevel+"L"+n.id;n.name=q.dims[0].name.trim();n.value=h.valueToShow(q);n.centerX=(k[1][0]+k[0][0])/2;n.centerY=(k[1][1]+k[0][1])/2;n.tooltip=h.getTooltip(n);i.push(n);if(h.isPoiRequired){var p=c*(n.centerX-(j[1][0]+j[0][0])/2);var o=c*(n.centerY-(j[1][1]+j[0][1])/2);c=c*h.scaleModifier(p,o,f,e)}break}}});return{data:i,scale:c,origin:-(j[1][0]+j[0][0])/2+","+-(j[1][1]+j[0][1])/2}}}};panel_map.prototype.preparePoiData=function(m,b){var h=this;var f=(h.currentLevel!==h.maxDepth+1)?h.getParent(b):h.getSelf(b[0].dims[0].knownId);var l=[];for(var c=0,j=m.length;c<j;c++){var k=m[c];var a=[];a.caption=k.caption;a.description=k.description;a.color=(k.color===parseInt(k.color,10))?global.colorValue(k.color):k.color;a.symbol=k.symbol;a.points=[];for(var g=0,e=k.points.length;g<e;g++){var d=k.points[g];if(d.levels.indexOf(this.currentLevel)>-1){if(h.isInMultiPolygon(d.lon,d.lat,f)){a.points.push({uniqueId:d.caption+"L"+this.currentLevel,caption:d.caption,description:d.description,symbol:a.symbol,size:d.size,lat:d.lat,lon:d.lon,coordinates:this.projection([d.lon,d.lat]),color:a.color,tooltip:"<em>"+((d.description===undefined)?d.caption:d.description)+"</em>"})}}}l.push(a)}return l};panel_map.prototype.update=function(g,c){var e=this;e.data=g||e.data;c=c||{dim:-1,direction:0};if(e.valFraction&&e.meta.indicators[e.valToShow].fraction.hide){e.valFraction=false}if(!e.valFraction&&e.meta.indicators[e.valToShow].value.hide){e.valFraction=true}e.valMultiplier=(isNaN(parseFloat(e.meta.indicators[e.valToShow].fraction.multiplier)))?1:parseFloat(e.meta.indicators[e.valToShow].fraction.multiplier);var d=global.getAnimDuration(-1,e.panelId);e.currentLevel=(global.baseLevels[e.panelSide])[this.dimToShow].length+1;var h=e.prepareData(e.data.rows);if(h){e.panic(false);var f=d3.extent(h.data,function(i){return i.value});var b=(f[0]*f[1]<0)?0:(f[0]+f[1])/2;e.setColorRange(f[0],b,f[1]);e.drawMap(h,c,d);e.drawLabels(h,d);e.drawLegend(d);if(e.isPoiRequired){e.drawPois(h,e.preparePoiData(e.pois,e.data.rows),d);e.drawPoiLegend(d)}if(c.direction!==0||c.dim<0){e.svg.selectAll(".mapHolder").transition().duration(d).attr("transform","translate("+e.projection.translate()+")scale("+h.scale+")translate("+h.origin+")")}}else{e.panic(true,"<html>Az adat térképen nem megjeleníthető.</html>")}var a=e.meta.indicators[e.valToShow];e.titleBox.update(e.valToShow,a.caption,a.value.unit,a.fraction.unit,e.valFraction,d)};panel_map.prototype.drawMap=function(c,a,e){var d=this;var f=d.gMapHolder.selectAll(".subunit").data(c.data,function(g){return g.uniqueId});f.exit().on("click",null).classed("darkenable",false).transition().duration(e).attr("opacity",0).remove();f.enter().append("svg:path").attr("class","subunit listener").attr("d",d.path).attr("fill",function(g){return d.colorLinear(g.value)}).attr("stroke-width",global.mapBorder/c.scale).attr("opacity",0);f.on("click",function(g){d.drill(g)}).transition().duration(e).attr("fill",function(g){return d.colorLinear(g.value)}).attr("opacity",1).each("end",function(){d3.select(this).classed("darkenable",true)});if(a.direction!==0||a.dim<0){var b=d.mask.selectAll("path").data(c.data,function(g){return g.uniqueId});b.enter().append("svg:path").attr("d",d.path).attr("opacity",(a.direction===-1)?1:0).transition().duration((a.direction===1)?e:0).attr("opacity",1);b.exit().transition().delay((a.direction===1)?e:0).duration((a.direction===1)?0:e).attr("opacity",0).remove()}};panel_map.prototype.drawLabels=function(a,c){var b=this;var d=b.gLabelHolder.selectAll(".mapLabel").data(a.data,function(e){return e.id+"N"+e.name}).moveToFront();d.transition().duration(c).attr("fill",function(e){return global.readableColor(b.colorLinear(e.value))});d.exit().transition().duration(c).attr("opacity",0).remove();d.enter().append("svg:text").attr("class","mapLabel").attr("text-anchor","middle").attr("x",function(e){return e.centerX}).attr("y",function(e){return e.centerY}).attr("fill",function(e){return global.readableColor(b.colorLinear(e.value))}).attr("opacity",0).text(function(e){return e.name}).style("font-size",(b.mapLabelSize/a.scale)+"px").transition().duration(c).attr("opacity",b.mapLabelOpacity)};panel_map.prototype.drawPois=function(a,g,f){var e=this;var d=e.gPoiHolder.selectAll(".gPoi").data(g);d.enter().append("svg:g").attr("class",function(j,h){return"gPoi inactive gPoi"+h});var c=d.selectAll("g").data(function(h){return h.points},function(h){return h.uniqueId});var b=c.enter().append("svg:g");c.exit().transition().duration(f).attr("opacity",0).remove();b.attr("transform",function(h){return"translate("+h.coordinates[0]+", "+h.coordinates[1]+")"}).attr("opacity",0);b.append("svg:path").attr("d",function(h){return d3.svg.symbol().type(d3.svg.symbolTypes[h.symbol]).size((h.size/a.scale)*(h.size/a.scale))()}).attr("fill",function(h){return h.color});b.append("svg:text").attr("y",function(h){return -h.size/a.scale/1.8}).attr("dy","-0.35em").attr("text-anchor","middle").text(function(h){return h.caption}).style("font-size",(e.mapLabelSize/a.scale)+"px");b.transition().duration(f).attr("opacity",1)};panel_map.prototype.drawPoiLegend=function(f){var e=this;if(e.gPoiLegend.selectAll(".poiLegend").empty()){for(var d=0,a=e.pois.length;d<a;d++){e.pois[d].tooltip="<h4>"+e.pois[d].description+"</h4>"}var b=e.gPoiLegend.attr("transform","translate("+(e.w-e.poiLegendWidth-global.legendOffsetX)+", "+(e.h-2*global.legendOffsetY-global.legendHeight-e.pois.length*e.poiLegendHeight)+")").style("opacity",0);b.transition().duration(f).style("opacity",1);b.append("svg:rect").attr("class","bordered").attr("rx",global.rectRounding).attr("ry",global.rectRounding).attr("width",e.poiLegendWidth).attr("height",e.pois.length*e.poiLegendHeight);var h=e.gPoiLegend.selectAll("g").data(e.pois).enter();var g=h.append("svg:g").attr("class",function(k,j){return"listener inactive poiLegend legendControl"+j}).attr("transform",function(k,j){return"translate(0, "+j*e.poiLegendHeight+")"}).on("mouseover",function(k,j){if(!d3.select(this).classed("inactive")){e.gLabelHolder.classed("opaque",true);e.gPoiHolder.selectAll(".gPoi"+j).classed("opaque",false).classed("noText",false);e.gPoiHolder.selectAll(".gPoi:not(.gPoi"+j+")").classed("opaque",true)}}).on("mouseout",function(){e.gLabelHolder.classed("opaque",false);e.gPoiHolder.selectAll(".gPoi").classed("opaque",false);e.gPoiHolder.selectAll(".gPoi").classed("noText",true)}).on("click",function(k,j){e.tooglePoi(j)});g.append("svg:rect").attr("rx",global.rectRounding).attr("ry",global.rectRounding).attr("width",e.poiLegendWidth).attr("height",e.poiLegendHeight);g.append("svg:path").attr("class","lineSymbol legend noEvents").attr("d",function(i){return d3.svg.symbol().type(d3.svg.symbolTypes[i.symbol]).size(e.poiLegendRadius*e.poiLegendRadius)()}).attr("fill",function(i){return(i.color===parseInt(i.color,10))?global.colorValue(i.color):i.color}).attr("transform","translate("+(e.poiLegendRadius+5)+", "+(e.poiLegendHeight/2)+")");var c=g.append("svg:text").attr("class","legend noEvents").attr("text-anchor","beginning").attr("x",2*(e.poiLegendRadius+5)).attr("y",(e.poiLegendHeight/2)).attr("dy",".35em").text(function(i){return i.caption});global.cleverCompress(c,panel_map.prototype.poiLegendWidth-(2*e.poiLegendRadius+20),1,undefined)}};panel_map.prototype.drawLegend=function(c){var b=this;var e=b.colorScale.ticks(b.legendTicks);if(e.length===0){e=[b.colorScale.domain()[0]]}var d=b.legendWidth/e.length;var a=global.legendHeight;b.gLegend.selectAll("path, text").transition().delay(c).duration(0).remove();b.gLegend.selectAll().data(e).enter().append("svg:path").attr("class","bordered").attr("d",function(g,f){return global.rectanglePath(f*d+global.legendOffsetX,b.h-a-global.legendOffsetY,(f===e.length-1)?d:d+1,a,(f===0)?global.rectRounding:0,(f===e.length-1)?global.rectRounding:0,(f===e.length-1)?global.rectRounding:0,(f===0)?global.rectRounding:0)}).attr("fill",b.colorScale).attr("opacity",0).transition().duration(c).attr("opacity",1);b.gLegend.selectAll().data(e).enter().append("svg:text").attr("text-anchor","middle").attr("x",function(g,f){return(f*d+d/2+global.legendOffsetX)}).attr("y",b.h-a/2-global.legendOffsetY).attr("dy",".35em").attr("fill",function(f){return global.readableColor(b.colorScale(f))}).attr("opacity",0).text(function(g,f){return global.cleverRound3(e[f])}).transition().duration(c).attr("opacity",1)};panel_map.prototype.tooglePoi=function(b){var a=this.gPoiLegend.select(".legendControl"+b);var c=!a.classed("inactive");a.classed("inactive",c);this.gPoiHolder.select(".gPoi"+b).classed("inactive",c);this.gPoiHolder.select(".gPoi"+b).classed("noText",c);this.gLabelHolder.classed("opaque",!c);this.gPoiHolder.selectAll(".gPoi").classed("opaque",false)};panel_map.prototype.drill=function(b){global.tooltip.kill();var a={dim:this.dimToShow,direction:(b===undefined)?1:-1,toId:(b===undefined)?undefined:b.id,toName:(b===undefined)?undefined:b.name};this.mediator.publish("drill",a)};panel_map.prototype.doChangeValue=function(a,d,b){var c=this;if(a===undefined||a===c.panelId){if(d!==undefined){c.valToShow=(d===-1)?(c.valToShow+1)%c.meta.indicators.length:d;c.actualInit.val=c.valToShow}if(b!==undefined){c.valFraction=(b===-1)?!c.valFraction:b;c.actualInit.ratio=c.valFraction}if(!c.isColorsLocked){c.colorRange=[c.defaultColorMin,global.colorValue(c.valToShow),c.defaultColorMax]}c.update()}};panel_map.prototype.doChangeDimension=function(a,b){var c=this;if(a===c.panelId){if(c.meta.dimensions[b].is_territorial===1){c.dimToShow=b;c.actualInit.dim=c.dimToShow;c.mediator.publish("register",c,c.panelId,[c.dimToShow],c.preUpdate,c.update);global.tooltip.kill();c.currentLevel=undefined;this.maxDepth=c.meta.dimensions[c.dimToShow].levels.length-1;this.mediator.publish("drill",{dim:-2,direction:0,toId:undefined})}}};